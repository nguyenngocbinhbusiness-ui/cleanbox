name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build with PyInstaller
        run: |
          pyinstaller --onefile --windowed --name CleanBox --icon src/assets/icon.ico --path src src/main.py

      - name: Create portable ZIP
        run: |
          $version = "${{ github.ref_name }}"
          Compress-Archive -Path dist/CleanBox.exe -DestinationPath "CleanBox-$version-windows-x64-portable.zip"

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            dist/CleanBox.exe
            CleanBox-${{ github.ref_name }}-windows-x64-portable.zip

  build-macos:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build with PyInstaller
        run: |
          pyinstaller --onefile --windowed --name CleanBox --path src src/main.py

      - name: Create DMG
        run: |
          mkdir -p dmg_contents
          cp dist/CleanBox dmg_contents/
          hdiutil create -volname "CleanBox" -srcfolder dmg_contents -ov -format UDZO CleanBox-${{ github.ref_name }}-macos.dmg

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: |
            CleanBox-${{ github.ref_name }}-macos.dmg

  build-linux:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libxcb-cursor0 libxkbcommon-x11-0 libegl1

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build with PyInstaller
        run: |
          pyinstaller --onefile --name CleanBox --path src src/main.py

      - name: Create AppImage
        run: |
          # Download appimagetool
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          
          # Create AppDir structure
          mkdir -p CleanBox.AppDir/usr/bin
          mkdir -p CleanBox.AppDir/usr/share/icons/hicolor/256x256/apps
          
          cp dist/CleanBox CleanBox.AppDir/usr/bin/
          
          # Create desktop file
          cat > CleanBox.AppDir/CleanBox.desktop << EOF
          [Desktop Entry]
          Type=Application
          Name=CleanBox
          Exec=CleanBox
          Icon=cleanbox
          Categories=Utility;
          EOF
          
          # Create AppRun
          cat > CleanBox.AppDir/AppRun << EOF
          #!/bin/bash
          exec "\$APPDIR/usr/bin/CleanBox" "\$@"
          EOF
          chmod +x CleanBox.AppDir/AppRun
          
          # Create simple icon (placeholder)
          convert -size 256x256 xc:transparent -fill "#4CAF50" -draw "circle 128,128 128,20" CleanBox.AppDir/usr/share/icons/hicolor/256x256/apps/cleanbox.png || echo "Icon creation skipped"
          cp CleanBox.AppDir/usr/share/icons/hicolor/256x256/apps/cleanbox.png CleanBox.AppDir/cleanbox.png 2>/dev/null || touch CleanBox.AppDir/cleanbox.png
          
          # Build AppImage
          ARCH=x86_64 ./appimagetool-x86_64.AppImage CleanBox.AppDir CleanBox-${{ github.ref_name }}-linux-x86_64.AppImage || true

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: |
            CleanBox-${{ github.ref_name }}-linux-x86_64.AppImage
            dist/CleanBox

  release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    
    steps:
      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: windows

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-build
          path: macos

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-build
          path: linux

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            windows/dist/CleanBox.exe
            windows/*.zip
            macos/*.dmg
            linux/*.AppImage
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "## ðŸŽ‰ Release ${{ github.ref_name }} Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts:" >> $GITHUB_STEP_SUMMARY
          echo "- **Windows**: \`CleanBox.exe\`, \`CleanBox-${{ github.ref_name }}-windows-x64-portable.zip\`" >> $GITHUB_STEP_SUMMARY
          echo "- **macOS**: \`CleanBox-${{ github.ref_name }}-macos.dmg\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Linux**: \`CleanBox-${{ github.ref_name }}-linux-x86_64.AppImage\`" >> $GITHUB_STEP_SUMMARY
