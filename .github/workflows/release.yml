name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Install NSIS
        run: choco install nsis -y

      - name: Build portable EXE using spec file
        run: pyinstaller CleanBox.spec --noconfirm

      - name: Create portable ZIP
        run: |
          $version = "${{ github.ref_name }}"
          Compress-Archive -Path dist/CleanBox.exe -DestinationPath "CleanBox-$version-windows-x64-portable.zip"

      - name: Build for NSIS installer (onedir mode)
        run: |
          Remove-Item -Recurse -Force dist -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force build -ErrorAction SilentlyContinue
          python -c "
          import PyInstaller.__main__
          PyInstaller.__main__.run([
              'src/main.py',
              '--onedir',
              '--windowed',
              '--name=CleanBox',
              '--icon=src/assets/icon.ico',
              '--add-data=src/assets;assets',
              '--path=src',
              '--hidden-import=features',
              '--hidden-import=features.cleanup',
              '--hidden-import=features.cleanup.service',
              '--hidden-import=features.cleanup.directory_detector',
              '--hidden-import=features.cleanup.worker',
              '--hidden-import=features.notifications',
              '--hidden-import=features.notifications.service',
              '--hidden-import=features.storage_monitor',
              '--hidden-import=features.storage_monitor.service',
              '--hidden-import=features.storage_monitor.utils',
              '--hidden-import=features.folder_scanner',
              '--hidden-import=shared',
              '--hidden-import=shared.constants',
              '--hidden-import=shared.registry',
              '--hidden-import=shared.utils',
              '--hidden-import=shared.config',
              '--hidden-import=shared.config.manager',
              '--hidden-import=ui',
              '--hidden-import=ui.main_window',
              '--hidden-import=ui.tray_icon',
              '--hidden-import=ui.components',
              '--hidden-import=ui.components.sidebar',
              '--hidden-import=ui.views',
              '--hidden-import=ui.views.cleanup_view',
              '--hidden-import=ui.views.settings_view',
              '--hidden-import=ui.views.storage_view',
              '--noconfirm',
          ])
          "

      - name: Create NSIS installer script
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          @"
          !include "MUI2.nsh"
          
          Name "CleanBox"
          OutFile "CleanBox-v$version-windows-x64-setup.exe"
          InstallDir "`$PROGRAMFILES\CleanBox"
          RequestExecutionLevel admin
          
          !insertmacro MUI_PAGE_DIRECTORY
          !insertmacro MUI_PAGE_INSTFILES
          !insertmacro MUI_LANGUAGE "English"
          
          Section "Install"
            SetOutPath "`$INSTDIR"
            File /r "dist\CleanBox\*.*"
            CreateShortcut "`$DESKTOP\CleanBox.lnk" "`$INSTDIR\CleanBox.exe"
            CreateDirectory "`$SMPROGRAMS\CleanBox"
            CreateShortcut "`$SMPROGRAMS\CleanBox\CleanBox.lnk" "`$INSTDIR\CleanBox.exe"
            CreateShortcut "`$SMPROGRAMS\CleanBox\Uninstall.lnk" "`$INSTDIR\uninstall.exe"
            WriteUninstaller "`$INSTDIR\uninstall.exe"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\CleanBox" "DisplayName" "CleanBox"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\CleanBox" "UninstallString" "`$INSTDIR\uninstall.exe"
          SectionEnd
          
          Section "Uninstall"
            Delete "`$DESKTOP\CleanBox.lnk"
            RMDir /r "`$SMPROGRAMS\CleanBox"
            RMDir /r "`$INSTDIR"
            DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\CleanBox"
          SectionEnd
          "@ | Out-File -FilePath installer.nsi -Encoding ASCII

      - name: Build NSIS installer
        run: |
          & "C:\Program Files (x86)\NSIS\makensis.exe" installer.nsi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            CleanBox-${{ github.ref_name }}-windows-x64-portable.zip
            CleanBox-${{ github.ref_name }}-windows-x64-setup.exe
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "## ðŸŽ‰ Release ${{ github.ref_name }} Complete!" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "### Artifacts:" >> $env:GITHUB_STEP_SUMMARY
          echo "- ``CleanBox-${{ github.ref_name }}-windows-x64-portable.zip`` - Portable package" >> $env:GITHUB_STEP_SUMMARY
          echo "- ``CleanBox-${{ github.ref_name }}-windows-x64-setup.exe`` - NSIS Installer" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "> **Note:** CleanBox is a Windows-only utility (uses Windows-specific APIs)." >> $env:GITHUB_STEP_SUMMARY
